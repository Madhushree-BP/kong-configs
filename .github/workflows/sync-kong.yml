on:
  workflow_dispatch:
  schedule:
    - cron: "30 18 * * *"

permissions:
  contents: write

env:
  main: kong-config

jobs:
  sync:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Download and install decK (Windows)
        shell: powershell
        run: |
          Write-Host "Downloading decK for Windows..."
          Invoke-WebRequest -Uri "https://github.com/kong/deck/releases/download/v1.21.0/deck_1.21.0_windows_amd64.tar.gz" -OutFile "deck.tar.gz"
          tar -xzf deck.tar.gz
          $deckPath = "$env:RUNNER_TEMP\deck.exe"
          Move-Item .\deck.exe $deckPath -Force
          & $deckPath version

      - name: Export Kong configuration
        shell: powershell
        env:
          KONG_ADMIN_URL: ${{ secrets.KONG_ADMIN_URL }}
          KONG_ADMIN_TOKEN: ${{ secrets.KONG_ADMIN_TOKEN }}
        run: |
          $deckPath = "$env:RUNNER_TEMP\deck.exe"
          $outputFile = "$env:GITHUB_WORKSPACE\kong.yaml"
          if (Test-Path $outputFile) { Remove-Item $outputFile -Force }
          $maxRetries = 3
          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              & $deckPath dump -o $outputFile --kong-addr "$env:KONG_ADMIN_URL" --headers "Kong-Admin-Token: $env:KONG_ADMIN_TOKEN" --tls-skip-verify --timeout 60
              if ($LASTEXITCODE -eq 0) { break }
              else { throw }
            } catch {
              if ($i -lt $maxRetries) { Start-Sleep 10 }
              else { exit 1 }
            }
          }

      - name: Show diff (optional)
        shell: powershell
        run: |
          git config core.autocrlf false
          $diff = git --no-pager diff -- kong.yaml 2>$null | Out-String
          if ([string]::IsNullOrWhiteSpace($diff)) { Write-Host "No diff found." }
          else { Write-Host $diff }

      - name: Commit & push if changed
        shell: powershell
        run: |
          git config user.email "actions@github.com"
          git config user.name "Kong Auto Sync"
          git fetch origin
          if (git ls-remote --exit-code --heads origin "${env:main}") { git checkout "${env:main}" }
          else { git checkout -b "${env:main}" }
          git add kong.yaml
          if (git diff --cached --quiet) { Write-Host "No changes" }
          else {
            git commit -m "Auto update"
            git push origin "${env:main}"
          }
