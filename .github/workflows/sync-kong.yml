name: Sync Kong Config

# manual + scheduled (daily at 00:00 IST)
on:
  workflow_dispatch:   # allows manual run from Actions UI
  schedule:
    - cron: "30 18 * * *"   # runs daily at 00:00 IST (18:30 UTC previous day)

permissions:
  contents: write   # allow pushing changes to repo

env:
  main: kong-config   # change to 'main' if you want main

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true   # allow push using GITHUB_TOKEN

      - name: Install decK
        run: |
         curl -sL https://github.com/kong/deck/releases/download/v1.21.0/deck_1.21.0_linux_amd64.tar.gz -o deck.tar.gz
          tar -xzf deck.tar.gz
          sudo mv deck /usr/local/bin/deck || true
          deck version || true

      - name: Export Kong config
        env:
          KONG_ADMIN_URL: ${{ secrets.KONG_ADMIN_URL }}
          KONG_TOKEN: ${{ secrets.KONG_TOKEN }}
        run: |
          # ensure we have a clean copy
          deck dump --all -o kong.yaml --kong-addr "${KONG_ADMIN_URL}" --headers "Kong-Admin-Token: ${KONG_TOKEN}"

      - name: Show diff (optional)
        run: |
          git --no-pager diff -- kong.yaml || true

      - name: Commit & push if changed
        run: |
          git config user.email "actions@github.com"
          git config user.name "Kong Auto Sync"
          # switch to target branch (create it if missing)
          git fetch origin
          if git ls-remote --exit-code --heads origin "${main}"; then
            git checkout "${main}"
          else
            git checkout -b "${main}"
          fi
          # copy kong.yaml into repo root (deck already puts it here)
          git add kong.yaml
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto update Kong config - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push origin "${main}"
          fi
